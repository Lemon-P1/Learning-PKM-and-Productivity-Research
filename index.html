import React, { useState, useEffect, useRef } from 'react';
import { 
  Brain, 
  Settings, 
  Workflow, 
  FlaskConical, 
  Zap, 
  CheckCircle2, 
  ArrowRight, 
  Sparkles, 
  BookOpen, 
  Clock, 
  Moon, 
  Coffee,
  Lightbulb,
  MessageSquare
} from 'lucide-react';
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, PointElement, LineElement, BarElement, Title } from 'chart.js';
import { Doughnut, Line, Bar } from 'react-chartjs-2';

ChartJS.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, PointElement, LineElement, BarElement, Title);

const apiKey = ""; // API key is provided by the environment

const App = () => {
  const [activeTab, setActiveTab] = useState('bio');
  const [user, setUser] = useState(null);
  const [journalEntries, setJournalEntries] = useState([]);
  const [paraTab, setParaTab] = useState('projects');
  const [workflowStep, setWorkflowStep] = useState(0);
  const [isGenerating, setIsGenerating] = useState(false);

  // Gemini API helper with exponential backoff
  const callGemini = async (prompt, systemPrompt = "You are a helpful neuro-productivity expert.") => {
    let delay = 1000;
    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
          })
        });
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;
      } catch (err) {
        if (i === 4) throw err;
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2;
      }
    }
  };

  const tabs = [
    { id: 'bio', label: '1. Bio-Hardware', icon: <Moon size={18} /> },
    { id: 'os', label: '2. Knowledge OS', icon: <Settings size={18} /> },
    { id: 'workflow', label: '3. Workflow Engine', icon: <Workflow size={18} /> },
    { id: 'lab', label: '4. Learning Lab', icon: <FlaskConical size={18} /> },
    { id: 'action', label: '5. Action Center', icon: <Zap size={18} /> },
  ];

  return (
    <div className="min-h-screen bg-[#F9FAFB] text-[#374151] font-sans">
      {/* Navigation */}
      <nav className="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
          <div className="flex items-center gap-2">
            <div className="bg-blue-600 p-1.5 rounded-lg text-white">
              <Brain size={24} />
            </div>
            <span className="text-xl font-bold tracking-tight">Neuro<span className="text-blue-600">Hub</span></span>
          </div>
          <div className="hidden md:flex space-x-6">
            {tabs.map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all border-b-2 ${
                  activeTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-900'
                }`}
              >
                {tab.icon}
                {tab.label}
              </button>
            ))}
          </div>
        </div>
      </nav>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {activeTab === 'bio' && <BioHardwareView />}
        {activeTab === 'os' && <KnowledgeOSView paraTab={paraTab} setParaTab={setParaTab} />}
        {activeTab === 'workflow' && <WorkflowView callGemini={callGemini} isGenerating={isGenerating} setIsGenerating={setIsGenerating} />}
        {activeTab === 'lab' && <LearningLabView callGemini={callGemini} isGenerating={isGenerating} setIsGenerating={setIsGenerating} />}
        {activeTab === 'action' && <ActionCenterView callGemini={callGemini} journalEntries={journalEntries} setJournalEntries={setJournalEntries} isGenerating={isGenerating} setIsGenerating={setIsGenerating} />}
      </main>
    </div>
  );
};

const BioHardwareView = () => {
  const sleepData = {
    labels: ['Declarative Memory', 'Creative Synthesis', 'Light Sleep'],
    datasets: [{
      data: [4, 3, 1],
      backgroundColor: ['#3B82F6', '#F59E0B', '#E5E7EB'],
      borderWidth: 0,
    }]
  };

  const rhythmData = {
    labels: ['Productivity Cycle'],
    datasets: [
      { label: 'Sit (Focus)', data: [20], backgroundColor: '#9CA3AF' },
      { label: 'Stand (Blood)', data: [8], backgroundColor: '#3B82F6' },
      { label: 'Move (Reset)', data: [2], backgroundColor: '#10B981' }
    ]
  };

  return (
    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">Biological Hardware Optimization</h1>
        <p className="text-gray-600 max-w-2xl">Upgrade your cognitive foundation through physiological protocols. We focus on sleep architecture and ergonomic rhythms to prevent mental decay.</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h2 className="text-xl font-bold mb-4">The 7-Hour Sleep Architecture</h2>
          <div className="h-64 flex justify-center">
            <Doughnut data={sleepData} options={{ maintainAspectRatio: false }} />
          </div>
          <div className="mt-4 p-4 bg-blue-50 rounded-xl text-sm text-blue-800">
            <strong>The 4+3 Rule:</strong> You need the first 4 hours for <em>facts</em> and the last 3 hours for <em>creative synthesis</em>. Skipping the last 3 hours destroys your ability to connect ideas.
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h2 className="text-xl font-bold mb-4">The 20-8-2 Rhythm</h2>
          <div className="h-64 flex justify-center">
            <Bar 
              data={rhythmData} 
              options={{ 
                indexAxis: 'y', 
                scales: { x: { stacked: true }, y: { stacked: true, display: false } },
                maintainAspectRatio: false 
              }} 
            />
          </div>
          <div className="mt-4 space-y-2">
            <div className="flex items-center gap-3 text-sm p-2 bg-gray-50 rounded-lg">
              <Coffee className="text-gray-400" size={16} /> 20m Focused Sitting
            </div>
            <div className="flex items-center gap-3 text-sm p-2 bg-blue-50 rounded-lg">
              <Zap className="text-blue-600" size={16} /> 8m Dynamic Standing
            </div>
            <div className="flex items-center gap-3 text-sm p-2 bg-green-50 rounded-lg">
              <CheckCircle2 className="text-green-600" size={16} /> 2m Micro-Movement
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const KnowledgeOSView = ({ paraTab, setParaTab }) => {
  const paraItems = {
    projects: { title: 'Projects', color: 'blue', desc: 'Active efforts with a deadline.' },
    areas: { title: 'Areas', color: 'green', desc: 'Ongoing responsibilities (Health, Finance).' },
    resources: { title: 'Resources', color: 'amber', desc: 'Themes of ongoing interest.' },
    archives: { title: 'Archives', color: 'gray', desc: 'Completed or inactive items.' }
  };

  return (
    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
      <h1 className="text-3xl font-bold text-gray-900 mb-6">Knowledge Operating System</h1>
      <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-8">
        <div className="grid grid-cols-4 divide-x border-b">
          {Object.keys(paraItems).map(key => (
            <button
              key={key}
              onClick={() => setParaTab(key)}
              className={`py-4 text-center text-sm font-bold transition-all ${
                paraTab === key ? `bg-${paraItems[key].color}-50 text-${paraItems[key].color}-700` : 'text-gray-400 hover:text-gray-600'
              }`}
            >
              {paraItems[key].title}
            </button>
          ))}
        </div>
        <div className="p-8 bg-white min-h-[120px]">
          <h3 className="text-xl font-bold mb-2">{paraItems[paraTab].title}</h3>
          <p className="text-gray-600">{paraItems[paraTab].desc}</p>
        </div>
      </div>
    </div>
  );
};

const WorkflowView = ({ callGemini, isGenerating, setIsGenerating }) => {
  const [note, setNote] = useState("");
  const [distilledNote, setDistilledNote] = useState("");

  const handleDistill = async () => {
    if (!note) return;
    setIsGenerating(true);
    try {
      const prompt = `Perform "Progressive Summarization" on this raw note. 
      1. Bold the most unique and useful phrases.
      2. Provide a 2-sentence Executive Summary at the top.
      3. Format it beautifully with spacing.
      Note: ${note}`;
      
      const result = await callGemini(prompt, "You are an expert at information architecture and the CODE workflow.");
      setDistilledNote(result);
    } catch (e) {
      console.error(e);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
      <h1 className="text-3xl font-bold text-gray-900 mb-2">The CODE Workflow Engine</h1>
      <p className="text-gray-600 mb-8">Move information from Capture to Expression using the four stages of digital metabolism.</p>
      
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-1 space-y-4">
          <div className="p-4 bg-white rounded-xl border border-blue-100 shadow-sm">
            <h3 className="font-bold flex items-center gap-2 text-blue-700 mb-2"><Workflow size={18}/> 1. Capture</h3>
            <p className="text-sm text-gray-500">Capture what resonates. Don't worry about where it fits yet.</p>
          </div>
          <div className="p-4 bg-white rounded-xl border border-gray-100 shadow-sm opacity-60">
            <h3 className="font-bold flex items-center gap-2 mb-2"><CheckCircle2 size={18}/> 2. Organize</h3>
            <p className="text-sm text-gray-500">File into PARA folders based on actionability.</p>
          </div>
          <div className="p-4 bg-blue-600 text-white rounded-xl shadow-lg ring-4 ring-blue-100">
            <h3 className="font-bold flex items-center gap-2 mb-2"><Sparkles size={18}/> 3. Distill</h3>
            <p className="text-sm text-blue-100">AI-powered summarization to extract the soul of the note.</p>
          </div>
          <div className="p-4 bg-white rounded-xl border border-gray-100 shadow-sm opacity-60">
            <h3 className="font-bold flex items-center gap-2 mb-2"><Zap size={18}/> 4. Express</h3>
            <p className="text-sm text-gray-500">Create output based on your knowledge base.</p>
          </div>
        </div>

        <div className="lg:col-span-2 space-y-4">
          <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-lg">✨ AI Note Distiller</h3>
              <button 
                onClick={handleDistill}
                disabled={isGenerating || !note}
                className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all"
              >
                {isGenerating ? 'Processing...' : <><Sparkles size={16} /> Distill with AI ✨</>}
              </button>
            </div>
            <textarea
              className="w-full h-40 p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm"
              placeholder="Paste a long article, messy meeting notes, or ideas here..."
              value={note}
              onChange={(e) => setNote(e.target.value)}
            />
            {distilledNote && (
              <div className="mt-6 p-6 bg-blue-50 rounded-xl border border-blue-100 prose prose-sm max-w-none">
                <div className="flex items-center gap-2 text-blue-800 font-bold mb-4">
                  <BookOpen size={16} /> Distilled Result
                </div>
                <div className="text-gray-700 whitespace-pre-wrap leading-relaxed">
                  {distilledNote}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

const LearningLabView = ({ callGemini, isGenerating, setIsGenerating }) => {
  const [topic, setTopic] = useState("");
  const [explanation, setExplanation] = useState("");

  const handleFeynman = async () => {
    if (!topic) return;
    setIsGenerating(true);
    try {
      const prompt = `Explain "${topic}" like I am 5 years old. Use a clever analogy. At the end, list 3 "concept gaps" I might have if I don't understand the fundamentals.`;
      const result = await callGemini(prompt, "You are an expert tutor specializing in the Feynman Technique.");
      setExplanation(result);
    } catch (e) {
      console.error(e);
    } finally {
      setIsGenerating(false);
    }
  };

  const chartData = {
    labels: ['Day 0', 'Day 1', 'Day 2', 'Day 3', 'Day 7', 'Day 14', 'Day 30'],
    datasets: [
      {
        label: 'Passive Reading',
        data: [100, 30, 20, 15, 10, 5, 2],
        borderColor: '#9CA3AF',
        borderDash: [5, 5],
        tension: 0.4
      },
      {
        label: 'Spaced Repetition',
        data: [100, 95, 90, 88, 85, 82, 80],
        borderColor: '#3B82F6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.4
      }
    ]
  };

  return (
    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
      <h1 className="text-3xl font-bold text-gray-900 mb-6">Learning Laboratory</h1>
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h2 className="text-xl font-bold mb-4">Retention Curve Performance</h2>
          <div className="h-64">
            <Line data={chartData} options={{ maintainAspectRatio: false }} />
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold">✨ Feynman Concept Explorer</h2>
            <Lightbulb className="text-amber-500" />
          </div>
          <p className="text-sm text-gray-500 mb-4">Identify gaps in your understanding by simplifying complex topics with AI.</p>
          <div className="flex gap-2 mb-4">
            <input 
              type="text" 
              className="flex-grow p-2 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" 
              placeholder="e.g. Quantum Entanglement"
              value={topic}
              onChange={(e) => setTopic(e.target.value)}
            />
            <button 
              onClick={handleFeynman}
              disabled={isGenerating || !topic}
              className="bg-amber-500 hover:bg-amber-600 disabled:opacity-50 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all"
            >
              {isGenerating ? 'Thinking...' : 'Simplify ✨'}
            </button>
          </div>
          {explanation && (
            <div className="p-4 bg-amber-50 rounded-xl border border-amber-100 flex-grow overflow-auto text-sm leading-relaxed whitespace-pre-wrap">
              {explanation}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const ActionCenterView = ({ callGemini, journalEntries, setJournalEntries, isGenerating, setIsGenerating }) => {
  const [prevTask, setPrevTask] = useState("");
  const [nextTask, setNextTask] = useState("");

  const handleLog = async () => {
    if (!prevTask || !nextTask) return;
    setIsGenerating(true);
    
    try {
      const prompt = `I just finished: "${prevTask}". 
      My next priority is: "${nextTask}". 
      Provide:
      1. A "Cognitive Reset" instruction (e.g. deep breath, physical stretch).
      2. A "Pro Tip" for starting the next task with maximum flow.
      Keep it brief and encouraging.`;
      
      const coachFeedback = await callGemini(prompt, "You are a high-performance productivity coach specializing in task transitions.");
      
      const newEntry = {
        id: Date.now(),
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        prev: prevTask,
        next: nextTask,
        feedback: coachFeedback
      };
      
      setJournalEntries([newEntry, ...journalEntries]);
      setPrevTask("");
      setNextTask("");
    } catch (e) {
      console.error(e);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
      <h1 className="text-3xl font-bold text-gray-900 mb-6">Action Center</h1>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
            <Clock className="text-blue-600" /> Interstitial Log
          </h2>
          <div className="space-y-4">
            <div>
              <label className="text-xs font-bold text-gray-400 uppercase">Just Finished</label>
              <input 
                className="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-blue-500" 
                placeholder="Finished emails..."
                value={prevTask}
                onChange={(e) => setPrevTask(e.target.value)}
              />
            </div>
            <div>
              <label className="text-xs font-bold text-gray-400 uppercase">Starting Next</label>
              <input 
                className="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-blue-500" 
                placeholder="Writing chapter 1..."
                value={nextTask}
                onChange={(e) => setNextTask(e.target.value)}
              />
            </div>
            <button 
              onClick={handleLog}
              disabled={isGenerating || !prevTask || !nextTask}
              className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2"
            >
              {isGenerating ? 'Consulting Coach...' : <>Log & Reset ✨</>}
            </button>
          </div>
        </div>

        <div className="lg:col-span-2 space-y-4">
          <h2 className="text-lg font-bold text-gray-500">Timeline of Transitions</h2>
          {journalEntries.length === 0 ? (
            <div className="p-20 text-center text-gray-400 bg-gray-50 rounded-2xl border border-dashed border-gray-200">
              <MessageSquare className="mx-auto mb-4 opacity-20" size={48} />
              No entries logged yet. Start your first transition.
            </div>
          ) : (
            journalEntries.map(entry => (
              <div key={entry.id} className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex gap-6 animate-in slide-in-from-left-4">
                <div className="text-center">
                  <div className="text-xs font-bold text-gray-400 uppercase tracking-widest">{entry.time}</div>
                  <div className="h-full w-px bg-gray-100 mx-auto my-2"></div>
                </div>
                <div className="flex-grow space-y-4">
                  <div className="flex items-center gap-4 text-sm">
                    <div className="px-3 py-1 bg-gray-100 rounded-full text-gray-500 line-through">Done: {entry.prev}</div>
                    <ArrowRight className="text-blue-500" size={16} />
                    <div className="px-3 py-1 bg-blue-100 rounded-full text-blue-700 font-bold">Next: {entry.next}</div>
                  </div>
                  {entry.feedback && (
                    <div className="p-4 bg-gray-50 rounded-xl border border-gray-100 text-sm italic text-gray-600 relative">
                      <Sparkles className="absolute -top-2 -right-2 text-blue-400" size={20} />
                      <div className="whitespace-pre-wrap">{entry.feedback}</div>
                    </div>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

export default App;
